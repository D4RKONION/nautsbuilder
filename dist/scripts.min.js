/* Nautsbuilder - Awesomenauts build calculator v0.7.1 - https://github.com/Leimi/awesomenauts-build-maker
* Copyright (c) 2013 Emmanuel Pelletier
* This Source Code Form is subject to the terms of the Mozilla Public License, v2.0. If a copy of the MPL was not distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/. */
_.mixin({capitalized:function(a){return _.isString(a)?a.replace(/_/g," ").replace(/(?:^|\s)\S/g,function(a){return a.toUpperCase()}):!1},underscored:function(a){return _.isString(a)?a.replace(/[\s]+/g,"_"):!1},ununderscored:function(a){return _.isString(a)?a.replace(/_/g," "):!1},trim:function(a,b){if(!a)return"";b=b||null;if(typeof String.prototype.trim!="function"||b){var c=b?b:"\\s";return String(a).replace(new RegExp("^"+c+"+|"+c+"+$","g"),"")}return a.trim()},italics:function(a){return a?a.replace(/\n/g,"<br>").replace(/\*(.*)\*/,"<em>$1</em>"):""}}),Backbone.View.prototype.assign=function(a,b){a.setElement(this.$(b)).render()},Backbone.Model.prototype.toJSON=function(a){return _.extend({},_.clone(this.attributes),{cid:this.cid})},window.leiminauts=window.leiminauts||{},leiminauts.utils={treatEffects:function(a){var b=[];if(!_(a).isString())return a;var c=a.toLowerCase().split(";");return _(c).each(function(a,d){attribute=_(a).trim().split(":"),attribute[0]=_(attribute[0]).trim(),attribute[1]=_(attribute[1]).trim(),!attribute[0]&&!attribute[1]?c.splice(d,1):b.push({key:attribute[0],value:attribute[1]})},this),b},number:function(a,b){return a=a*1,_(a).isNaN()?a:(b=b||2,a%1!==0?a.toFixed(b):a)}},leiminauts.Character=Backbone.Model.extend({initialize:function(){this.skills=this.get("skills"),this.set("total_cost",0),this.set("maxed_out",!1),this.set("level",1),this.skills.on("change:total_cost",this.onCostChange,this),this.skills.on("change:maxed_out",this.onSkillComplete,this),this.on("change:selected",this.onSelectedChange,this)},onCostChange:function(){var a=0;this.skills.each(function(b){a+=b.get("total_cost")}),this.set("level",Math.floor((a-100)/100)<=1?1:Math.floor((a-100)/100)),this.set("total_cost",a)},onSkillComplete:function(){var a=!0;_(this.skills.pluck("maxed_out")).each(function(b){if(!b)return a=!1,!1}),this.set("maxed_out",a)},onSelectedChange:function(){this.skills.each(function(a){a.set("selected",this.get("selected"))},this)},reset:function(){this.skills.each(function(a){a.setActive(!1),a.get("toggable")||a.resetUpgradesState(!1)},this)}}),leiminauts.CharactersData=Backbone.Collection.extend({model:leiminauts.Character,initialize:function(a,b){if(b.spreadsheet!==undefined){this.spreadsheet=b.spreadsheet;var c,d,e;this.spreadsheet?(leiminauts.characters=this.spreadsheet.sheets("Characters").all(),leiminauts.skills=this.spreadsheet.sheets("Skills").all(),leiminauts.upgrades=this.spreadsheet.sheets("Upgrades").all(),Modernizr.localstorage&&(localStorage.setItem("nautsbuilder.characters",JSON.stringify(leiminauts.characters)),localStorage.setItem("nautsbuilder.skills",JSON.stringify(leiminauts.skills)),localStorage.setItem("nautsbuilder.upgrades",JSON.stringify(leiminauts.upgrades)),localStorage.setItem("nautsbuilder.date",(new Date).getTime()))):(leiminauts.characters=JSON.parse(localStorage.getItem("nautsbuilder.characters")),leiminauts.skills=JSON.parse(localStorage.getItem("nautsbuilder.skills")),leiminauts.upgrades=JSON.parse(localStorage.getItem("nautsbuilder.upgrades"))),_.each(leiminauts.characters,function(a){var b=_(leiminauts.skills).where({character:a.name});a.skills=new leiminauts.Skills(b),this.add(a)},this)}}}),leiminauts.Skill=Backbone.Model.extend({initialize:function(a,b){this.set("upgrades",new leiminauts.Upgrades),this.upgrades=this.get("upgrades"),this.on("change:selected",this.onSelectedChange,this)},onSelectedChange:function(){this.get("selected")?(this.upgrades.on("change",this.updateEffects,this),this.on("change:active",this.updateEffects,this),this.on("change:active",this.resetUpgradesState,this)):(this.upgrades.off("change",this.updateEffects,this),this.off("change:active",this.updateEffects,this),this.off("change:active",this.resetUpgradesState,this)),this.get("selected")&&this.get("upgrades").length<=0&&(this.set("maxed_out",!1),this._originalEffects=this.get("effects"),this.prepareBaseEffects(),this.initUpgrades(),this.set("total_cost",0),this.set("active",this.get("cost")!==undefined&&this.get("cost")<=0),this.set("toggable",!this.get("active")))},initUpgrades:function(){var a=[];if(this.get("type")=="jump"){a=_(leiminauts.upgrades).where({skill:"Jump"});var b=leiminauts.utils.treatEffects(this.get("effects")),c=_(b).findWhere({key:"pills"}),d="Power Pills Light";c&&c.value=="light"&&(d="Power Pills Turbo"),a.splice(_(a).indexOf(_(a).findWhere({name:d})),1);var e=leiminauts.utils.treatEffects(this._originalEffects);e.splice(_(e).indexOf(_(e).findWhere({key:"pills"})),1);var f=_(leiminauts.upgrades).where({skill:this.get("name")});_(a).each(function(b,c){_(f).each(function(d){d.replaces==b.name&&(a[c]=_(d).clone())})})}else a=_(leiminauts.upgrades).where({skill:this.get("name")});this.get("upgrades").reset(a),this.resetUpgradesState()},setActive:function(a){this.get("toggable")&&this.set("active",!!a)},resetUpgradesState:function(a){a=a!==undefined?a:!this.get("active"),this.upgrades.each(function(b){b.setStep(0),b.set("locked",a)},this),this.set("maxed_out",!1)},getActiveUpgrades:function(){var a=this.upgrades.filter(function(a){return a.get("active")===!0});return a},getActiveSteps:function(){var a=[];return this.upgrades.each(function(b){b.get("active")===!0&&a.push(b.get("current_step"))}),a},updateEffects:function(a){if(!this.get("selected"))return!1;if(!this.get("active"))return this.set("effects",[]),this.set("total_cost",0),!1;var b=this.getActiveUpgrades(),c=!0;b.length>=3?_(b).each(function(a){if(a.get("current_step").get("level")!==a.get("max_step"))return c=!1,!1}):c=!1,this.set("maxed_out",c);var d=this.getActiveSteps();this.upgrades.each(function(a){this.get("active")&&a.set("locked",b.length>=3&&!_(b).contains(a))},this);var e=parseInt(this.get("cost"),10);_(b).each(function(a){e+=a.get("current_step").get("level")*a.get("cost")}),this.set("total_cost",e),this.set("effects",[],{silent:!0});var f={},g=[],h=function(a){_(a).each(function(b){var c=b.value;a!==g&&c.toString().charAt(0)=="/"&&!_(parseFloat(c.substr(1))).isNaN()?g.push({key:b.key,value:c}):f[b.key]!==undefined?f[b.key].push(b.value):f[b.key]=[b.value]})};h(this.get("baseEffects")),_(d).each(function(a,b){h(a.get("attrs"))}),h(g);var i=/^(\+|-|\/)?([0-9]+[\.,]?[0-9]*)([%s])?$/i;_(f).each(function(a,b){var c="",d=!1;_(a).each(function(b,e){regexRes=i.exec(b);if(regexRes!==null){var f=!0,g=parseFloat(c);_(g).isNaN()&&(g=0),regexRes[3]&&regexRes[3]=="%"&&g!==0&&a[0].substr(-1)!="%"?(g+=parseFloat(a[0])*(parseFloat(b)/100),f=!1):regexRes[1]&&regexRes[1]=="/"?g=g/parseFloat(b.substr(1)):g+=parseFloat(b,10),g=leiminauts.utils.number(g),c=g,regexRes[3]&&f&&(c+=regexRes[3]),regexRes[1]&&regexRes[1]=="+"&&g>0&&(!d||d.toString().indexOf("+")===0)&&(c="+"+c)}else c=b;d=c}),this.get("effects").push({key:b,value:c})},this),this.setSpecificEffects(),this.setDPS(),this.set("effects",_(this.get("effects")).sortBy(function(a){return a.key.toLowerCase()}))},prepareBaseEffects:function(){if(!this.get("selected"))return!1;if(!_(this.get("effects")).isString())return!1;this.set("baseEffects",leiminauts.utils.treatEffects(this.get("effects")));if(this.get("type")=="jump"){var a=_(this.get("baseEffects"));a.splice(_(a).indexOf(_(a).findWhere({key:"pills"})),1);var b=a.findWhere({key:"solar"}),c=a.findWhere({key:"solar per min"});b||a.push({key:"solar",value:200}),c||a.push({key:"solar per min",value:30})}},setSpecificEffects:function(){if(!this.get("selected"))return!1;var a=_(this.get("effects")),b=0;if(this.get("name")=="Missiles"){var c=[],d=a.findWhere({key:"damage"}).value;_(4).times(function(){c.push(d)});var e=a.filter(function(a){return/^missile [0-9]$/.test(a.key)});_(e).each(function(b){var e=parseInt(b.key.substr(-1),10)-1;c[e]=(d+4*e)*parseInt(b.value,10),a.splice(_(a).indexOf(_(a).findWhere({key:b.key})),1)});while(c.length>1&&c[c.length-1]==d)c.pop();b=_(c).reduce(function(a,b){return a+b},0)/c.length,a.findWhere({key:"damage"}).value=c.join(" > "),a.push({key:"avg damage",value:leiminauts.utils.number(b)})}if(this.get("name")=="Bash"){var f=_(this.get("baseEffects")).findWhere({key:"damage"}).value.split(" > "),g=a.filter(function(a){return/^punch [0-9]$/.test(a.key)});_(g).each(function(b){var c=parseInt(b.key.substr(-1),10)-1;f[c]=f[c]*1+parseInt(b.value,10),a.splice(_(a).indexOf(_(a).findWhere({key:b.key})),1)}),b=_(f).reduce(function(a,b){return a+b*1},0)/f.length,a.findWhere({key:"damage"}).value=f.join(" > "),a.push({key:"avg damage",value:leiminauts.utils.number(b)})}if(this.get("name")=="Laser"){var h=a.findWhere({key:"damage"}).value,i=a.findWhere({key:"max damage"}).value,j=[];_(i-h).times(function(a){j.push(a+h)});var k=a.findWhere({key:"attack speed"}).value/60,l=a.findWhere({key:"time to next charge"}).value.replace("s","")*1,m=k*l,n=0;time=0,_(j).each(function(a){n+=m*a,time+=l});var o=n/time;a.push({key:"DPS until max",value:leiminauts.utils.number(o)}),a.push({key:"DPS max",value:leiminauts.utils.number(k*i)})}if(this.get("name")=="Spike Dive"){var n=a.findWhere({key:"damage"}).value,p=this.getActiveUpgrade("dead seahorse head"),q=null;if(p){a.splice(_(a).indexOf(_(a).findWhere({key:"extra spike"})),1);var q={key:"Extra Spike",value:n/2};a.push(q)}var r=this.getActiveUpgrade("bag full of gold fish"),s=a.findWhere({key:"damage with 100 solar"});r&&s&&(s.value=s.value*1+n,q&&a.push({key:"Extra Spike With 100 Solar",value:Math.floor(s.value/2)}))}},setDPS:function(){if(!this.get("selected"))return!1;if(this.get("name")=="Laser")return!1;var a=_(this.get("effects")),b=a.findWhere({key:"attack speed"}),c=a.findWhere({key:"avg damage"});c||(c=a.findWhere({key:"damage"}));var d=a.findWhere({key:"dps"});if(b&&c){var e=(parseFloat(b.value,10)/60*parseFloat(c.value,10)).toFixed(2);e=leiminauts.utils.number(e),d?d.value=e:a.push({key:"DPS",value:e})}},getActiveUpgrade:function(a){var b=_(this.getActiveUpgrades()).filter(function(b){return b.get("name").toLowerCase()==a.toLowerCase()});return b.length?b[0]:!1}}),leiminauts.Skills=Backbone.Collection.extend({model:leiminauts.Skill}),leiminauts.Upgrade=Backbone.Model.extend({defaults:{current_step:null,max_step:0,active:!1,locked:!1},initialize:function(a,b){var c=_(this.attributes).filter(function(a,b){return/^step[0-9]$/.test(b)&&a!==""}),d=new leiminauts.Steps([new leiminauts.Step({upgrade:this.toJSON()})]);_(c).each(function(a,b){d.add({level:b+1,description:a,upgrade:this.toJSON()})},this),this.set("steps",d),this.set("max_step",d.size()-1),this.set("description",_(this.get("description").replace(/\n/g,"<br>")).italics()),this.setStep(0)},setStep:function(a){a=parseInt(a,10);var b=this.get("steps").findWhere({level:a});this.set("current_step",b),this.set("active",b.get("level")>0)}}),leiminauts.Upgrades=Backbone.Collection.extend({model:leiminauts.Upgrade}),leiminauts.Step=Backbone.Model.extend({defaults:{level:0,description:""},initialize:function(){this.set("attrs",leiminauts.utils.treatEffects(this.get("description")))}}),leiminauts.Steps=Backbone.Collection.extend({model:leiminauts.Step}),leiminauts.CharactersView=Backbone.View.extend({className:"chars-list-container",events:{"click .char[data-id]":"selectCharacter"},initialize:function(){this.template=_.template($("#chars-tpl").html()),this.collection.on("add remove reset",this.render,this),this.options.character!==undefined&&(this.character=this.options.character.model.toJSON()),this.currentChar=null,this.mouseOverTimeout=null,this.$el.on("mouseover",".char",_.bind(_.debounce(this.showCharInfo,50),this))},render:function(){return this.$el.html(this.template({characters:this.collection.toJSON(),currentChar:this.currentChar,character:this.character})),this},selectCharacter:function(a){this.collection.trigger("selected",$(a.currentTarget).attr("data-id"))},showCharInfo:function(a){if(this.character)return!1;var b=$(a.currentTarget).find("a").attr("href").substr(1);if(this.currentChar===null||this.currentChar.get("name")!==_.ununderscored(b))this.currentChar=this.collection.findWhere({name:_.ununderscored(b)}),this.render()}}),leiminauts.CharacterView=Backbone.View.extend({tagName:"div",className:"char-builder",events:{},initialize:function(a){_.defaults(a,{build:null,order:null,info:null}),this.template=_.template($("#char-tpl").html()),this.characters=new leiminauts.CharactersView({character:this,collection:this.collection}),this.build=new leiminauts.BuildView({character:this}),this.info=new leiminauts.InfoView({character:this}),this.order=new leiminauts.OrderView({character:this}),this.order.on("changed",function(a){this.trigger("order:changed",a)},this),this.order.on("toggled",function(){this.trigger("order:toggled")},this),this.render(),this.model.on("change:maxed_out",this.toggleCompactView,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.assign(this.characters,".chars"),this.assign(this.build,".build"),this.assign(this.info,".char-info"),this.assign(this.order,".order"),this},toggleCompactView:function(){this.$el.toggleClass("maxed-out",this.model.get("maxed_out"))}}),leiminauts.BuildView=Backbone.View.extend({tagName:"div",className:"build",events:{"click .build-cancel":"reset"},initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.skills=[],this.model.get("skills").each(function(a){this.skills.push(new leiminauts.SkillView({model:a}))},this),this.template=_.template($("#build-tpl").html()),this.model.get("skills").on("change:active",this.toggleResetButtonClass,this),this.model.get("skills").each(_.bind(function(a){a.get("upgrades").on("change:active",this.toggleResetButtonClass,this)},this)),this.toggleResetButtonClass()},toggleResetButtonClass:function(){if(!this.$resetButton)return!1;var a=!1;this.model.get("skills").each(function(b){if(b.get("active")&&b.get("toggable")||b.getActiveUpgrades().length>0)return a=!0,!1}),this.$resetButton.toggleClass("active",a)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$resetButton=this.$(".build-cancel"),_(this.skills).each(function(a){a.delegateEvents(),this.$el.append(a.render().el)},this),this},reset:function(){this.model.get("skills").each(function(a){a.setActive(!1),a.get("toggable")||a.resetUpgradesState(!1)})}}),leiminauts.OrderView=Backbone.View.extend({tagName:"div",className:"order",initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.template=_.template($("#order-tpl").html()),this.active=!0,this.on("toggled",this.toggleView,this),this.collection=new Backbone.Collection(null,{comparator:this.comparator}),this.collection.on("reset",this.onBuildChange,this),this.model.get("skills").each(_.bind(function(a){a.get("upgrades").on("change:current_step",this.onBuildChange,this)},this)),this.model.get("skills").on("change:active",this.onBuildChange,this),this.on("sorted",this.render,this)},toggle:function(){this.active=!this.active,this.trigger("toggled")},toggleView:function(){if(!this.$el)return!1;this.$el.find("ul").toggleClass("hidden",!this.active),this.$el.find('input[name="active"]').prop("checked",this.active)},onBuildChange:function(a){this.updateCollection(a),this.render()},comparator:function(a){return a.get("order")||0},render:function(){var a=this.collection.toJSON(),b=0;return _(a).each(function(a){b+=a.upgrade?a.upgrade.cost*1:a.cost*1,a.order_total_cost=b,a.order_req_lvl=Math.floor((b-100)/100)<=1?1:Math.floor((b-100)/100)}),this.$el.html(this.template({items:a,active:this.active})),this.$(".order-item").on("mouseover mouseout click dragstart",this.handleTooltip),this.$('input[name="active"]').on("change",_.bind(this.toggle,this)),this.$list=this.$el.children("ul").first(),this.$list.sortable({items:".order-item"}),this.$list.on("sortupdate",_.bind(this.updateOrder,this)),this.toggleView(),this},updateCollection:function(a){if(a instanceof leiminauts.Skill)a.get("active")?this.collection.add(a,{sort:!1}):this.collection.remove(a);else if(a instanceof leiminauts.Upgrade){var b=a.get("current_step").get("level"),c=this.collection.filter(function(b){return b instanceof leiminauts.Step&&b.get("upgrade").name==a.get("name")});if(b!==0)if(b>1&&!c.length){var d=[];a.get("steps").each(function(a){a.get("level")<b&&d.push(a)}),this.collection.add(d,{sort:!1})}else this.collection.add(a.get("current_step"),{sort:!1});else this.collection.remove(c)}this.active&&this.trigger("changed",this.collection)},updateOrder:function(){return this.$list?(this.$list.children().each(_.bind(function(a,b){this.collection.get($(b).attr("data-cid")).set("order",a,{silent:!0})},this)),this.collection.sort(),this.active&&(this.trigger("changed",this.collection),this.trigger("sorted",this.collection)),!1):!1},handleTooltip:function(a){a.type=="mouseover"?MouseTooltip.show($(a.currentTarget).find(".order-popup").html()):MouseTooltip.hide()}}),leiminauts.SkillView=Backbone.View.extend({tagName:"div",className:"skill-wrapper",events:{"mouseover .skill-icon":"handleTooltip","mouseout .skill-icon":"handleTooltip","click .skill-icon":"toggleState","click .skill-cancel":"reset"},initialize:function(){this.upgrades=[],this.model.get("upgrades").each(function(a){this.upgrades.push(new leiminauts.UpgradeView({model:a}))},this),this.template=_.template($("#build-skill-tpl").html()),this.model.get("upgrades").on("change",this.renderUpgradesInfo,this),this.model.on("change",this.render,this)},toggleState:function(){this.model.setActive(!this.model.get("active"))},reset:function(){this.model.setActive(!1),this.model.get("toggable")||this.model.resetUpgradesState(!1)},render:function(){var a=this.model.toJSON();return this.$el.html()?(this.$(".skill").toggleClass("active",a.active),this.$(".skill").toggleClass("skill-maxed-out",a.maxed_out),this.$(".skill-effects").toggleClass("hidden",!a.effects.length),this.$(".skill-cancel").toggleClass("active",a.toggable&&a.active||a.upgrades.where({active:!0}).length>0),_(this.upgrades).invoke("delegateEvents")):(this.$el.html(this.template(a)),_(this.upgrades).each(function(a){a.delegateEvents(),this.$(".skill-upgrades").append(a.render().el)},this)),this.renderUpgradesInfo(),this},renderUpgradesInfo:function(){this.$(".skill-effects").html(_.template($("#build-skill-effects-tpl").html(),this.model.toJSON()))},handleTooltip:function(a){a.type!="mouseout"?MouseTooltip.show(this.$(".skill-popup").html()):MouseTooltip.hide()}}),leiminauts.UpgradeView=Backbone.View.extend({tagName:"div",className:"upgrade",events:{mouseover:"handleTooltip",mouseout:"handleTooltip",click:"onClick"},initialize:function(){this.template=_.template($("#build-upgrade-tpl").html()),this.model.on("change",this.render,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),_(["active","locked"]).each(function(a){this.$el.toggleClass(a,this.model.get(a))},this),this},onClick:function(a){this.updateStep(),this.handleTooltip(a)},handleTooltip:function(a){a.type!="mouseout"?MouseTooltip.show(this.$(".upgrade-popup").html()):MouseTooltip.hide()},updateStep:function(){if(this.model.get("locked"))return!1;var a=this.model.get("current_step")?this.model.get("current_step").get("level"):0;a>=this.model.get("max_step")?this.model.setStep(0):this.model.setStep(a+1)}}),leiminauts.App=Backbone.Router.extend({routes:{"":"list",":naut(/:build)(/:order)":"buildMaker"},initialize:function(a){a.spreadsheet!==undefined&&(this.data=new leiminauts.CharactersData(null,{spreadsheet:a.spreadsheet}),this.data.on("selected",function(a){this.navigate(a,{trigger:!0})},this)),this.$el=$(a.el),this.grid=[]},list:function(){$("body").removeClass("page-blue").addClass("page-red");var a=new leiminauts.CharactersView({collection:this.data});this.showView(a)},buildMaker:function(a,b,c){if(!_.isNaN(parseInt(a,10)))return!1;a=="Skolldir"&&(a="Skølldir"),a=_.ununderscored(a).toLowerCase();if(this.currentView&&this.currentView instanceof leiminauts.CharacterView&&this.currentView.model&&this.currentView.model.get("name").toLowerCase()==a)return this.updateBuildFromUrl(this.currentView),!0;$("body").addClass("page-blue").removeClass("page-red");var d=this.data.filter(function(b){var c=b.get("name").toLowerCase()==a;return b.set("selected",c),c});if(d.length)d=d[0];else return!1;d.reset();var e=new leiminauts.CharacterView({collection:this.data,model:d});this.showView(e),this._initGrid(),this.updateBuildFromUrl(e);var f=_.debounce(_.bind(function(){this.updateBuildUrl(e)},this),500);d.get("skills").on("change",f,this),e.on("order:changed",f,this),e.on("order:toggled",f,this)},showView:function(a){return this.currentView&&this.currentView.remove(),this.$el.html(a.render().el),this.currentView=a,a},updateBuildFromUrl:function(a){var b=a.model,c=this.getCurrentUrl(),d=c.split("/"),e=d.length>1?d[1]:null,f=d.length>2?d[2]:null;if(e===null)return b.reset(),!1;var g=null;for(var h=0;h<28;h++)h%7===0?(g=b.get("skills").at(h/7),g.setActive(e.charAt(h)==="1")):g&&g.get("upgrades").at(h%7-1).setStep(e.charAt(h));if(f){var i=this._initGrid(),j=f.split("-"),k=_(j).countBy(function(a){return a}),l={},m=[];_(j).each(function(a,b){var c=i[a-1];c instanceof leiminauts.Skill&&m.push(c),c instanceof leiminauts.Upgrade&&(k[a]>1||l[a]?(l[a]=l[a]?l[a]+1:1,k[a]=k[a]-1,m.push(c.get("steps").at(l[a]))):l[a]||m.push(c.get("steps").at(1)))}),a.order.collection.reset(m,{sort:!1})}else a.order.toggle()},updateBuildUrl:function(a){if(this.currentView instanceof leiminauts.CharactersView)return!1;var b=a.model,c=a.order.active?a.order.collection:null,d="",e=[],f="",g=[];b.get("skills").each(function(a){d+=a.get("active")?"1":"0",g.push(a),a.get("upgrades").each(function(a){g.push(a),d+=a.get("current_step").get("level")})}),c&&c.length>0&&(c.each(function(a){if(a instanceof leiminauts.Skill)e.push(_(g).indexOf(a)+1);else if(a instanceof leiminauts.Step){var b=_(g).filter(function(b){return b instanceof leiminauts.Upgrade&&b.get("name")==a.get("upgrade").name});b=b?b[0]:!1,b&&e.push(_(g).indexOf(b)+1)}}),f="/"+e.join("-"));var h=this.getCurrentUrl(),i="";h.indexOf("/")===-1?i=h+"/"+d+f:i=h.substring(0,h.indexOf("/")+1)+d+f,this.navigate(i)},getCurrentUrl:function(){return _(window.location.hash.substring(1)).trim("/").replace("ø","o")},_initGrid:function(){if(this.currentView instanceof leiminauts.CharacterView&&this.grid.length>0&&this.gridChar==this.currentView.model.get("name"))return this.grid;var a=[];this.currentView.model.get("skills").each(function(b){a.push(b),b.get("upgrades").each(function(b){a.push(b)})}),this.gridChar=this.currentView.model.get("name"),this.grid=a}}),function(){var a="0AuPP-DBESPOedF9hckdzMWVhc2c3Rkk1R2RTa1pUdWc";MouseTooltip.init({"3d":!0}),$("body").toggleClass("page-red",!window.location.hash.length),leiminauts.init=function(a){a=a||{},_.defaults(a,{el:"#container",spreadsheet:!1}),window.nautsbuilder=new leiminauts.App(a),Backbone.history.start({pushState:!1})},leiminauts.lastDataUpdate=leiminauts.lastDataUpdate||0,leiminauts.localDate=Modernizr.localstorage&&localStorage.getItem("nautsbuilder.date")?localStorage.getItem("nautsbuilder.date"):0;if(leiminauts.lastDataUpdate===0||leiminauts.lastDataUpdate>leiminauts.localDate)Tabletop.init({key:a,callback:function(a,b){leiminauts.init({spreadsheet:b})}});else{var b=!0;if(Modernizr.localstorage){var c=localStorage.getItem("nautsbuilder.characters"),d=localStorage.getItem("nautsbuilder.skills"),e=localStorage.getItem("nautsbuilder.upgrades");_([c,d,e]).each(function(a){if(!a||a==="undefined")return b=!1,!1}),b&&leiminauts.init({})}(!Modernizr.localstorage||!b)&&Tabletop.init({key:a,callback:function(a,b){leiminauts.init({spreadsheet:b})}})}}();