/* Nautsbuilder - Awesomenauts build calculator v0.6 - https://github.com/Leimi/awesomenauts-build-maker
* Copyright (c) 2013 Emmanuel Pelletier
* This Source Code Form is subject to the terms of the Mozilla Public License, v2.0. If a copy of the MPL was not distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/. */
_.mixin({capitalized:function(a){return _.isString(a)?a.replace(/_/g," ").replace(/(?:^|\s)\S/g,function(a){return a.toUpperCase()}):!1},underscored:function(a){return _.isString(a)?a.replace(/[\s]+/g,"_"):!1},ununderscored:function(a){return _.isString(a)?a.replace(/_/g," "):!1},trim:function(a,b){if(!a)return"";b=b||null;if(typeof String.prototype.trim!="function"||b){var c=b?b:"\\s";return String(a).replace(new RegExp("^"+c+"+|"+c+"+$","g"),"")}return a.trim()},italics:function(a){return a?a.replace(/\n/g,"<br>").replace(/\*(.*)\*/,"<em>$1</em>"):""}}),Backbone.View.prototype.assign=function(a,b){a.setElement(this.$(b)).render()},window.leiminauts=window.leiminauts||{},leiminauts.utils={treatEffects:function(a){var b=[];if(!_(a).isString())return a;var c=a.toLowerCase().split(";");return _(c).each(function(a,d){attribute=_(a).trim().split(":"),attribute[0]=_(attribute[0]).trim(),attribute[1]=_(attribute[1]).trim(),!attribute[0]&&!attribute[1]?c.splice(d,1):b.push({key:attribute[0],value:attribute[1]})},this),b},number:function(a,b){return a=a*1,_(a).isNaN()?a:(b=b||2,a%1!==0?a.toFixed(b):a)}},leiminauts.Character=Backbone.Model.extend({initialize:function(){this.set("totalCost",0),this.set("level",1),this.get("skills").on("change:totalCost",this.onCostChange,this),this.on("change:selected",this.onSelectedChange,this)},onCostChange:function(){var a=0;this.get("skills").each(function(b){a+=b.get("totalCost")}),this.set("level",Math.floor((a-100)/100)<=1?1:Math.floor((a-100)/100)),this.set("totalCost",a)},onSelectedChange:function(){this.get("skills").each(function(a){a.set("selected",this.get("selected"))},this)},reset:function(){this.get("skills").each(function(a){a.setActive(!1),a.get("toggable")||a.resetUpgradesState(!1)},this)}}),leiminauts.CharactersData=Backbone.Collection.extend({model:leiminauts.Character,initialize:function(a,b){if(b.spreadsheet!==undefined){this.spreadsheet=b.spreadsheet;var c,d,e;this.spreadsheet?(leiminauts.characters=this.spreadsheet.sheets("Characters").all(),leiminauts.skills=this.spreadsheet.sheets("Skills").all(),leiminauts.upgrades=this.spreadsheet.sheets("Upgrades").all(),Modernizr.localstorage&&(localStorage.setItem("nautsbuilder.characters",JSON.stringify(c)),localStorage.setItem("nautsbuilder.skills",JSON.stringify(d)),localStorage.setItem("nautsbuilder.upgrades",JSON.stringify(e)),localStorage.setItem("nautsbuilder.date",(new Date).getTime()))):(leiminauts.characters=JSON.parse(localStorage.getItem("nautsbuilder.characters")),leiminauts.skills=JSON.parse(localStorage.getItem("nautsbuilder.skills")),leiminauts.upgrades=JSON.parse(localStorage.getItem("nautsbuilder.upgrades"))),_.each(leiminauts.characters,function(a){var b=_(leiminauts.skills).where({character:a.name});a.skills=new leiminauts.Skills(b),this.add(a)},this)}}}),leiminauts.Skill=Backbone.Model.extend({initialize:function(a,b){this.set("upgrades",new leiminauts.Upgrades),this.upgrades=this.get("upgrades"),this.on("change:selected",this.onSelectedChange,this)},onSelectedChange:function(){this.get("selected")?(this.upgrades.on("change",this.updateEffects,this),this.on("change:active",this.updateEffects,this),this.on("change:active",this.resetUpgradesState,this)):(this.upgrades.off("change",this.updateEffects,this),this.off("change:active",this.updateEffects,this),this.off("change:active",this.resetUpgradesState,this)),this.get("selected")&&this.get("upgrades").length<=0&&(this._originalEffects=this.get("effects"),this.prepareBaseEffects(),this.initUpgrades(),this.set("totalCost",0),this.set("active",this.get("cost")!==undefined&&this.get("cost")<=0),this.set("toggable",!this.get("active")))},initUpgrades:function(){var a=[];if(this.get("type")=="jump"){a=_(leiminauts.upgrades).where({skill:"Jump"});var b=leiminauts.utils.treatEffects(this.get("effects")),c=_(b).findWhere({key:"pills"}),d="Power Pills Light";c&&c.value=="light"&&(d="Power Pills Turbo"),a.splice(_(a).indexOf(_(a).findWhere({name:d})),1);var e=leiminauts.utils.treatEffects(this._originalEffects);e.splice(_(e).indexOf(_(e).findWhere({key:"pills"})),1);var f=_(leiminauts.upgrades).where({skill:this.get("name")});_(a).each(function(b,c){_(f).each(function(d){d.replaces==b.name&&(a[c]=_(d).clone())})})}else a=_(leiminauts.upgrades).where({skill:this.get("name")});this.get("upgrades").reset(a),this.resetUpgradesState()},setActive:function(a){this.get("toggable")&&this.set("active",!!a)},resetUpgradesState:function(a){a=a!==undefined?a:!this.get("active"),this.upgrades.each(function(b){b.setStep(0),b.set("locked",a)},this)},getActiveUpgrades:function(){var a=this.upgrades.filter(function(a){return a.get("active")===!0});return a},getActiveSteps:function(){var a=[];return this.upgrades.each(function(b){b.get("active")===!0&&a.push(b.get("current_step"))}),a},updateEffects:function(a){if(!this.get("selected"))return!1;if(!this.get("active"))return this.set("effects",[]),this.set("totalCost",0),!1;var b=this.getActiveUpgrades(),c=this.getActiveSteps();this.upgrades.each(function(a){this.get("active")&&a.set("locked",b.length>=3&&!_(b).contains(a))},this);var d=parseInt(this.get("cost"),10);_(b).each(function(a){d+=a.get("current_step").get("level")*a.get("cost")}),this.set("totalCost",d),this.set("effects",[],{silent:!0});var e={},f=[],g=function(a){_(a).each(function(b){var c=b.value;a!==f&&c.toString().charAt(0)=="/"&&!_(parseFloat(c.substr(1))).isNaN()?f.push({key:b.key,value:c}):e[b.key]!==undefined?e[b.key].push(b.value):e[b.key]=[b.value]})};g(this.get("baseEffects")),_(c).each(function(a,b){g(a.get("attrs"))}),g(f);var h=/^(\+|-|\/)?([0-9]+[\.,]?[0-9]*)([%s])?$/i;_(e).each(function(a,b){var c="",d=!1;_(a).each(function(b,e){regexRes=h.exec(b);if(regexRes!==null){var f=!0,g=parseFloat(c);_(g).isNaN()&&(g=0),regexRes[3]&&regexRes[3]=="%"&&g!==0&&a[0].substr(-1)!="%"?(g+=parseFloat(a[0])*(parseFloat(b)/100),f=!1):regexRes[1]&&regexRes[1]=="/"?g=g/parseFloat(b.substr(1)):g+=parseFloat(b,10),g=leiminauts.utils.number(g),c=g,regexRes[3]&&f&&(c+=regexRes[3]),regexRes[1]&&regexRes[1]=="+"&&g>0&&(!d||d.toString().indexOf("+")===0)&&(c="+"+c)}else c=b;d=c}),this.get("effects").push({key:b,value:c})},this),this.setSpecificEffects(),this.setDPS(),this.set("effects",_(this.get("effects")).sortBy(function(a){return a.key.toLowerCase()}))},prepareBaseEffects:function(){if(!this.get("selected"))return!1;if(!_(this.get("effects")).isString())return!1;this.set("baseEffects",leiminauts.utils.treatEffects(this.get("effects")));if(this.get("type")=="jump"){var a=_(this.get("baseEffects"));a.splice(_(a).indexOf(_(a).findWhere({key:"pills"})),1);var b=a.findWhere({key:"solar"}),c=a.findWhere({key:"solar per min"});b||a.push({key:"solar",value:200}),c||a.push({key:"solar per min",value:30})}},setSpecificEffects:function(){if(!this.get("selected"))return!1;var a=_(this.get("effects")),b=0;if(this.get("name")=="Missiles"){var c=[],d=a.findWhere({key:"damage"}).value;_(4).times(function(){c.push(d)});var e=a.filter(function(a){return/^missile [0-9]$/.test(a.key)});_(e).each(function(b){var e=parseInt(b.key.substr(-1),10)-1;c[e]=(d+4*e)*parseInt(b.value,10),a.splice(_(a).indexOf(_(a).findWhere({key:b.key})),1)});while(c.length>1&&c[c.length-1]==d)c.pop();b=_(c).reduce(function(a,b){return a+b},0)/c.length,a.findWhere({key:"damage"}).value=c.join(" > "),a.push({key:"avg damage",value:leiminauts.utils.number(b)})}if(this.get("name")=="Bash"){var f=_(this.get("baseEffects")).findWhere({key:"damage"}).value.split(" > "),g=a.filter(function(a){return/^punch [0-9]$/.test(a.key)});_(g).each(function(b){var c=parseInt(b.key.substr(-1),10)-1;f[c]=f[c]*1+parseInt(b.value,10),a.splice(_(a).indexOf(_(a).findWhere({key:b.key})),1)}),b=_(f).reduce(function(a,b){return a+b*1},0)/f.length,a.findWhere({key:"damage"}).value=f.join(" > "),a.push({key:"avg damage",value:leiminauts.utils.number(b)})}if(this.get("name")=="Laser"){var h=a.findWhere({key:"damage"}).value,i=a.findWhere({key:"max damage"}).value,j=[];_(i-h).times(function(a){j.push(a+h)});var k=a.findWhere({key:"attack speed"}).value/60,l=a.findWhere({key:"time to next charge"}).value.replace("s","")*1,m=k*l,n=0;time=0,_(j).each(function(a){n+=m*a,time+=l});var o=n/time;a.push({key:"DPS until max",value:leiminauts.utils.number(o)}),a.push({key:"DPS max",value:leiminauts.utils.number(k*i)})}if(this.get("name")=="Spike Dive"){var p=_(this.getActiveUpgrades()).filter(function(a){return a.get("name")=="Dead Seahorse Head"});if(p.length)p=p[0];else return!1;var q=a.findWhere({key:"damage"}).value/2;a.push({key:"Extra Spike",value:leiminauts.utils.number(q)}),a.splice(_(a).indexOf(_(a).findWhere({key:"extra spike"})),1)}},setDPS:function(){if(!this.get("selected"))return!1;if(this.get("name")=="Laser")return!1;var a=_(this.get("effects")),b=a.findWhere({key:"attack speed"}),c=a.findWhere({key:"avg damage"});c||(c=a.findWhere({key:"damage"}));var d=a.findWhere({key:"dps"});if(b&&c){var e=(parseFloat(b.value,10)/60*parseFloat(c.value,10)).toFixed(2);e=leiminauts.utils.number(e),d?d.value=e:a.push({key:"DPS",value:e})}}}),leiminauts.Skills=Backbone.Collection.extend({model:leiminauts.Skill}),leiminauts.Upgrade=Backbone.Model.extend({defaults:{current_step:null,max_step:0,active:!1,locked:!1},initialize:function(a,b){var c=_(this.attributes).filter(function(a,b){return/^step[0-9]$/.test(b)&&a!==""}),d=new leiminauts.Steps([new leiminauts.Step]);_(c).each(function(a,b){d.add({level:b+1,description:a})}),this.set("steps",d),this.set("max_step",d.size()-1),this.set("description",_(this.get("description").replace(/\n/g,"<br>")).italics()),this.setStep(0)},setStep:function(a){a=parseInt(a,10);var b=this.get("steps").findWhere({level:a});this.set("current_step",b),this.set("active",b.get("level")>0)}}),leiminauts.Upgrades=Backbone.Collection.extend({model:leiminauts.Upgrade}),leiminauts.Step=Backbone.Model.extend({defaults:{level:0,description:""},initialize:function(){this.set("attrs",leiminauts.utils.treatEffects(this.get("description")))}}),leiminauts.Steps=Backbone.Collection.extend({model:leiminauts.Step}),leiminauts.CharactersView=Backbone.View.extend({className:"chars-list-container",events:{"click .char":"selectCharacter"},initialize:function(){this.template=_.template($("#chars-tpl").html()),this.collection.on("add remove reset",this.render,this),this.options.character!==undefined&&(this.character=this.options.character.model.toJSON()),this.currentChar=null,this.mouseOverTimeout=null,this.$el.on("mouseover",".char",_.bind(_.debounce(this.showCharInfo,50),this))},render:function(){return this.$el.html(this.template({characters:this.collection.toJSON(),currentChar:this.currentChar,character:this.character})),this},selectCharacter:function(a){this.collection.trigger("selected",$(a.currentTarget).attr("data-id"))},showCharInfo:function(a){if(this.character)return!1;var b=$(a.currentTarget).attr("data-id");if(this.currentChar===null||this.currentChar.get("name")!==_.ununderscored(b))this.currentChar=this.collection.findWhere({name:_.ununderscored(b)}),this.render()}}),leiminauts.CharacterView=Backbone.View.extend({tagName:"div",className:"char-builder",events:{},initialize:function(a){_.defaults(a,{build:null,order:null,info:null}),this.template=_.template($("#char-tpl").html()),this.characters=new leiminauts.CharactersView({character:this,collection:this.collection}),this.build=new leiminauts.BuildView({character:this}),this.info=new leiminauts.InfoView({character:this}),this.order=new leiminauts.OrderView({character:this}),this.render()},render:function(){return $("body").attr("data-page","char"),this.$el.html(this.template(this.model.toJSON())),this.assign(this.characters,".chars"),this.assign(this.build,".build"),this.assign(this.info,".char-info"),this.assign(this.order,".order"),this}}),leiminauts.BuildView=Backbone.View.extend({tagName:"div",className:"build",events:{"click .build-cancel":"reset"},initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.skills=[],this.model.get("skills").each(function(a){this.skills.push(new leiminauts.SkillView({model:a}))},this),this.template=_.template($("#build-tpl").html()),this.model.get("skills").on("change:active",this.toggleResetButtonClass,this),this.model.get("skills").each(_.bind(function(a){a.get("upgrades").on("change:active",this.toggleResetButtonClass,this)},this)),this.toggleResetButtonClass()},toggleResetButtonClass:function(){if(!this.$resetButton)return!1;var a=!1;this.model.get("skills").each(function(b){if(b.get("active")&&b.get("toggable")||b.getActiveUpgrades().length>0)return a=!0,!1}),this.$resetButton.toggleClass("active",a)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$resetButton=this.$(".build-cancel"),_(this.skills).each(function(a){a.delegateEvents(),this.$el.append(a.render().el)},this),this},reset:function(){this.model.get("skills").each(function(a){a.setActive(!1),a.get("toggable")||a.resetUpgradesState(!1)})}}),leiminauts.OrderView=Backbone.View.extend({tagName:"div",className:"order",events:{},initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.template=_.template($("#order-tpl").html())},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),leiminauts.SkillView=Backbone.View.extend({tagName:"div",className:"skill-wrapper",events:{"mouseover .skill-icon":"handleTooltip","mouseout .skill-icon":"handleTooltip","click .skill-icon":"toggleState","click .skill-cancel":"reset"},initialize:function(){this.upgrades=[],this.model.get("upgrades").each(function(a){this.upgrades.push(new leiminauts.UpgradeView({model:a}))},this),this.template=_.template($("#build-skill-tpl").html()),this.model.get("upgrades").on("change",this.renderUpgradesInfo,this),this.model.on("change",this.render,this)},toggleState:function(){this.model.setActive(!this.model.get("active"))},reset:function(){this.model.setActive(!1),this.model.get("toggable")||this.model.resetUpgradesState(!1)},render:function(){return this.$el.html(this.template(this.model.toJSON())),_(this.upgrades).each(function(a){a.delegateEvents(),this.$(".skill-upgrades").append(a.render().el)},this),this.renderUpgradesInfo(),this},renderUpgradesInfo:function(){this.$(".skill-effects").html(_.template($("#build-skill-effects-tpl").html(),this.model.toJSON()))},handleTooltip:function(a){a.type!="mouseout"?MouseTooltip.show(this.$(".skill-popup").html()):MouseTooltip.hide()}}),leiminauts.UpgradeView=Backbone.View.extend({tagName:"div",className:"upgrade",events:{mouseover:"handleTooltip",mouseout:"handleTooltip",click:"onClick"},initialize:function(){this.template=_.template($("#build-upgrade-tpl").html()),this.model.on("change",this.render,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),_(["active","locked"]).each(function(a){this.$el.toggleClass(a,this.model.get(a))},this),this},onClick:function(a){this.updateStep(),this.handleTooltip(a)},handleTooltip:function(a){a.type!="mouseout"?MouseTooltip.show(this.$(".upgrade-popup").html()):MouseTooltip.hide()},updateStep:function(){if(this.model.get("locked"))return!1;var a=this.model.get("current_step")?this.model.get("current_step").get("level"):0;a>=this.model.get("max_step")?this.model.setStep(0):this.model.setStep(a+1)}}),leiminauts.App=Backbone.Router.extend({routes:{"":"list",":naut(/:build)(/:order)":"buildMaker"},initialize:function(a){a.spreadsheet!==undefined&&(this.data=new leiminauts.CharactersData(null,{spreadsheet:a.spreadsheet}),this.data.on("selected",function(a){this.navigate(a,{trigger:!0})},this)),this.$el=$(a.el)},list:function(){$("body").removeClass("page-blue").addClass("page-red");var a=new leiminauts.CharactersView({collection:this.data});this.showView(a)},buildMaker:function(a,b,c){if(!_.isNaN(parseInt(a,10)))return!1;a=="Skolldir"&&(a="Skølldir"),a=_.ununderscored(a).toLowerCase();if(this.currentView&&this.currentView instanceof leiminauts.CharacterView&&this.currentView.model&&this.currentView.model.get("name").toLowerCase()==a)return this.updateBuildFromUrl(this.currentView.model),!0;$("body").addClass("page-blue").removeClass("page-red");var d=this.data.filter(function(b){var c=b.get("name").toLowerCase()==a;return b.set("selected",c),c});if(d.length)d=d[0];else return!1;d.reset();var e=new leiminauts.CharacterView({collection:this.data,model:d});this.showView(e),this.updateBuildFromUrl(d);var f=_.debounce(_.bind(function(){this.updateBuildUrl(d)},this),500);d.get("skills").on("change",f,this)},showView:function(a){return this.currentView&&this.currentView.remove(),this.$el.html(a.render().el),this.currentView=a,a},updateBuildFromUrl:function(a){var b=this.getCurrentUrl(),c=b.split("/"),d=c.length>1?c[1]:null;if(d===null)return a.reset(),!1;var e=null;for(var f=0;f<28;f++)f%7===0?(e=a.get("skills").at(f/7),e.setActive(d.charAt(f)==="1")):e&&e.get("upgrades").at(f%7-1).setStep(d.charAt(f))},updateBuildUrl:function(a){if(this.currentView instanceof leiminauts.CharactersView)return!1;var b="";a.get("skills").each(function(a){b+=a.get("active")?"1":"0",a.get("upgrades").each(function(a){b+=a.get("current_step").get("level")})});var c=this.getCurrentUrl(),d="";c.indexOf("/")===-1?d=c+"/"+b:(d=c.substring(0,c.indexOf("/")+1)+b,c.indexOf("/")!==c.lastIndexOf("/")&&(d+=c.substring(c.lastIndexOf("/")))),this.navigate(d)},getCurrentUrl:function(){return _(window.location.hash.substring(1)).trim("/").replace("ø","o")}}),function(){MouseTooltip.init({"3d":!0}),$("body").toggleClass("page-red",!window.location.hash.length),leiminauts.init=function(a){a=a||{},_.defaults(a,{el:"#container",spreadsheet:!1}),window.nautsbuilder=new leiminauts.App(a),Backbone.history.start({pushState:!1,root:"/nautsbuilder/"})},leiminauts.lastDataUpdate=new Date("April 30, 2013 09:00:00 GMT+0200"),leiminauts.localDate=Modernizr.localstorage&&localStorage.getItem("nautsbuilder.date")||0,leiminauts.localDate=0,leiminauts.lastDataUpdate.getTime()>leiminauts.localDate?Tabletop.init({key:"0AuPP-DBESPOedF9hckdzMWVhc2c3Rkk1R2RTa1pUdWc",wait:!1,debug:!1,callback:function(a,b){leiminauts.init({spreadsheet:b})}}):leiminauts.init({})}();