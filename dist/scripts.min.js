/* Nautsbuilder - Awesomenauts build calculator v0.8.4 - https://github.com/Leimi/awesomenauts-build-maker
* Copyright (c) 2013 Emmanuel Pelletier
* This Source Code Form is subject to the terms of the Mozilla Public License, v2.0. If a copy of the MPL was not distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/. */
_.mixin({capitalized:function(e){return _.isString(e)?e.replace(/_/g," ").replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()}):!1},underscored:function(e){return _.isString(e)?e.replace(/[\s]+/g,"_"):!1},ununderscored:function(e){return _.isString(e)?e.replace(/_/g," "):!1},trim:function(e,t){if(!e)return"";t=t||null;if(typeof String.prototype.trim!="function"||t){var n=t?t:"\\s";return String(e).replace(new RegExp("^"+n+"+|"+n+"+$","g"),"")}return e.trim()},italics:function(e){return e?e.replace(/\n/g,"<br>").replace(/\*(.*)\*/,"<em>$1</em>"):""}}),Backbone.View.prototype.assign=function(e,t){e.setElement(this.$(t)).render()},Backbone.Model.prototype.toJSON=function(e){return _.extend({},_.clone(this.attributes),{cid:this.cid})},window.leiminauts=window.leiminauts||{},leiminauts.utils={treatEffects:function(e){var t=[];if(!_(e).isString())return e;var n=e.toLowerCase().split(";");return _(n).each(function(e,r){attribute=_(e).trim().split(":"),attribute[0]=_(attribute[0]).trim(),attribute[1]=_(attribute[1]).trim(),!attribute[0]&&!attribute[1]?n.splice(r,1):t.push({key:attribute[0],value:attribute[1]})},this),t},number:function(e,t){return e*=1,_(e).isNaN()?e:(t=t||2,e%1!==0?e.toFixed(t):e)},dps:function(e,t){return leiminauts.utils.number((parseFloat(t)/60*parseFloat(e)).toFixed(2))}},leiminauts.Character=Backbone.Model.extend({initialize:function(){this.skills=this.get("skills"),this.set("total_cost",0),this.set("maxed_out",!1),this.set("level",1),this.skills.on("change:total_cost",this.onCostChange,this),this.skills.on("change:maxed_out",this.onSkillComplete,this),this.on("change:selected",this.onSelectedChange,this)},onCostChange:function(){var e=0;this.skills.each(function(t){e+=t.get("total_cost")}),this.set("level",Math.floor((e-100)/100)<=1?1:Math.floor((e-100)/100)),this.set("total_cost",e)},onSkillComplete:function(){var e=!0;_(this.skills.pluck("maxed_out")).each(function(t){if(!t)return e=!1,!1}),this.set("maxed_out",e)},onSelectedChange:function(){this.skills.each(function(e){e.set("selected",this.get("selected"))},this)},reset:function(){this.skills.each(function(e){e.setActive(!1),e.get("toggable")||e.resetUpgradesState(!1)},this)}}),leiminauts.CharactersData=Backbone.Collection.extend({model:leiminauts.Character,initialize:function(e,t){if(t.spreadsheet!==undefined){this.spreadsheet=t.spreadsheet,this.console=t.console||!1;var n,r,i;this.spreadsheet?(leiminauts.characters=this.spreadsheet.characters,leiminauts.skills=this.spreadsheet.skills,leiminauts.upgrades=this.spreadsheet.upgrades,!this.console&&Modernizr.localstorage&&(localStorage.setItem("nautsbuilder.characters",JSON.stringify(leiminauts.characters)),localStorage.setItem("nautsbuilder.skills",JSON.stringify(leiminauts.skills)),localStorage.setItem("nautsbuilder.upgrades",JSON.stringify(leiminauts.upgrades)),localStorage.setItem("nautsbuilder.date",(new Date).getTime()))):(leiminauts.characters=JSON.parse(localStorage.getItem("nautsbuilder.characters")),leiminauts.skills=JSON.parse(localStorage.getItem("nautsbuilder.skills")),leiminauts.upgrades=JSON.parse(localStorage.getItem("nautsbuilder.upgrades"))),_.each(leiminauts.characters,function(e){var t=_(leiminauts.skills).where({character:e.name});e.skills=new leiminauts.Skills(t),this.add(e)},this)}}}),leiminauts.Skill=Backbone.Model.extend({initialize:function(e,t){this.set("upgrades",new leiminauts.Upgrades),this.upgrades=this.get("upgrades"),this.on("change:selected",this.onSelectedChange,this)},onSelectedChange:function(){this.get("selected")?(this.upgrades.on("change",this.updateEffects,this),this.on("change:active",this.updateEffects,this),this.on("change:active",this.resetUpgradesState,this)):(this.upgrades.off("change",this.updateEffects,this),this.off("change:active",this.updateEffects,this),this.off("change:active",this.resetUpgradesState,this)),this.get("selected")&&this.get("upgrades").length<=0&&(this.set("maxed_out",!1),this._originalEffects=this.get("effects"),this.prepareBaseEffects(),this.initUpgrades(),this.set("total_cost",0),this.set("active",this.get("cost")!==undefined&&this.get("cost")<=0),this.set("toggable",!this.get("active")))},initUpgrades:function(){var e=[];if(this.get("type")=="jump"){e=_(leiminauts.upgrades).where({skill:"Jump"});var t=leiminauts.utils.treatEffects(this.get("effects")),n=_(t).findWhere({key:"pills"}),r="Power Pills Light";n&&n.value=="light"&&(r="Power Pills Turbo"),e.splice(_(e).indexOf(_(e).findWhere({name:r})),1);var i=leiminauts.utils.treatEffects(this._originalEffects);i.splice(_(i).indexOf(_(i).findWhere({key:"pills"})),1);var s=_(leiminauts.upgrades).where({skill:this.get("name")});_(e).each(function(t,n){_(s).each(function(r){r.replaces==t.name&&(e[n]=_(r).clone())})})}else e=_(leiminauts.upgrades).where({skill:this.get("name")}),_(e).each(function(e){e.skill=this},this);this.get("upgrades").reset(e),this.resetUpgradesState()},setActive:function(e){this.get("toggable")&&this.set("active",!!e)},resetUpgradesState:function(e){e=e!==undefined?e:!this.get("active"),this.upgrades.each(function(t){t.setStep(0),t.set("locked",e)},this),this.set("maxed_out",!1)},getActiveUpgrades:function(){var e=this.upgrades.filter(function(e){return e.get("active")===!0});return e},getActiveSteps:function(){var e=[];return this.upgrades.each(function(t){t.get("active")===!0&&e.push(t.get("current_step"))}),e},updateEffects:function(e){if(!this.get("selected"))return!1;if(!this.get("active"))return this.set("effects",[]),this.set("total_cost",0),!1;var t=this.getActiveUpgrades(),n=!0;t.length>=3?_(t).each(function(e){if(e.get("current_step").get("level")!==e.get("max_step"))return n=!1,!1}):n=!1,this.set("maxed_out",n);var r=this.getActiveSteps();this.upgrades.each(function(e){this.get("active")&&e.set("locked",t.length>=3&&!_(t).contains(e))},this);var i=parseInt(this.get("cost"),10);_(t).each(function(e){i+=e.get("current_step").get("level")*e.get("cost")}),this.set("total_cost",i),this.set("effects",[],{silent:!0});var s={},o=[],u=function(e){_(e).each(function(t){var n=t.value;e!==o&&n.toString().charAt(0)=="/"&&!_(parseFloat(n.substr(1))).isNaN()?o.push({key:t.key,value:n}):s[t.key]!==undefined?s[t.key].push(t.value):s[t.key]=[t.value]})};u(this.get("baseEffects")),_(r).each(function(e,t){u(e.get("attrs"))}),u(o);var a=/^(\+|-|\/)?([0-9]+[\.,]?[0-9]*)([%s])?$/i;_(s).each(function(e,t){var n="",r=!1;_(e).each(function(t,i){regexRes=a.exec(t);if(regexRes!==null){var s=!0,o=parseFloat(n);_(o).isNaN()&&(o=0),regexRes[3]&&regexRes[3]=="%"&&o!==0&&e[0].substr(-1)!="%"?(o+=parseFloat(e[0])*(parseFloat(t)/100),s=!1):regexRes[1]&&regexRes[1]=="/"?o/=parseFloat(t.substr(1)):o+=parseFloat(t,10),o=leiminauts.utils.number(o),n=o,regexRes[3]&&s&&(n+=regexRes[3]),regexRes[1]&&regexRes[1]=="+"&&o>0&&(!r||r.toString().indexOf("+")===0)&&(n="+"+n)}else n=t;r=n}),this.get("effects").push({key:t,value:n})},this),this.setSpecificEffects(),this.setDPS(),this.set("effects",_(this.get("effects")).sortBy(function(e){return e.key.toLowerCase()}))},prepareBaseEffects:function(){if(!this.get("selected"))return!1;if(!_(this.get("effects")).isString())return!1;this.set("baseEffects",leiminauts.utils.treatEffects(this.get("effects")));if(this.get("type")=="jump"){var e=_(this.get("baseEffects"));e.splice(_(e).indexOf(_(e).findWhere({key:"pills"})),1);var t=e.findWhere({key:"solar"}),n=e.findWhere({key:"solar per min"});t||e.push({key:"solar",value:200}),n||e.push({key:"solar per min",value:30})}},setSpecificEffects:function(){if(!this.get("selected"))return!1;var e=_(this.get("effects")),t=0;if(this.get("name")=="Missiles"){var n=[],r=e.findWhere({key:"damage"}).value;_(4).times(function(){n.push(r)});var i=e.filter(function(e){return/^missile [0-9]$/.test(e.key)});_(i).each(function(t){var i=parseInt(t.key.substr(-1),10)-1;n[i]=(r+4*i)*parseInt(t.value,10),e.splice(_(e).indexOf(_(e).findWhere({key:t.key})),1)});while(n.length>1&&n[n.length-1]==r)n.pop();t=_(n).reduce(function(e,t){return e+t},0)/n.length,e.findWhere({key:"damage"}).value=n.join(" > "),e.push({key:"avg damage",value:leiminauts.utils.number(t)})}if(this.get("name")=="Bash"){var s=_(this.get("baseEffects")).findWhere({key:"damage"}).value.split(" > "),o=e.filter(function(e){return/^punch [0-9]$/.test(e.key)});_(o).each(function(t){var n=parseInt(t.key.substr(-1),10)-1;s[n]=s[n]*1+parseInt(t.value,10),e.splice(_(e).indexOf(_(e).findWhere({key:t.key})),1)}),t=_(s).reduce(function(e,t){return e+t*1},0)/s.length,e.findWhere({key:"damage"}).value=s.join(" > "),e.push({key:"avg damage",value:leiminauts.utils.number(t)})}if(this.get("name")=="Laser"){var u=e.findWhere({key:"damage"}).value,a=e.findWhere({key:"max damage"}).value,f=[];_(a-u).times(function(e){f.push(e+u)});var l=e.findWhere({key:"attack speed"}).value/60,c=e.findWhere({key:"time to next charge"}).value.replace("s","")*1,h=l*c,p=0;time=0,_(f).each(function(e){p+=h*e,time+=c});var d=p/time;e.push({key:"DPS until max",value:leiminauts.utils.number(d)}),e.push({key:"DPS max",value:leiminauts.utils.number(l*a)})}if(this.get("name")=="Spike Dive"){var p=e.findWhere({key:"damage"}).value,v=this.getActiveUpgrade("dead seahorse head"),m=null;if(v){e.splice(_(e).indexOf(_(e).findWhere({key:"extra spike"})),1);var m={key:"Extra Spike",value:p/2};e.push(m)}var g=this.getActiveUpgrade("bag full of gold fish"),y=e.findWhere({key:"damage with 100 solar"});g&&y&&(y.value=y.value*1+p,m&&e.push({key:"Extra Spike With 100 Solar",value:Math.floor(y.value/2)}))}if(this.get("name")=="Evil Eye"){var b=this.getActiveUpgrade("toothbrush shank");if(b){var p=_(this.get("baseEffects")).findWhere({key:"damage"}).value.split(" > ");toothbrushVal=b.get("current_step").get("level")>0?b.get("current_step").get("attrs"):null;if(toothbrushVal){var w=parseInt(_(toothbrushVal).findWhere({key:"damage"}).value,10),E=[];_(p).each(function(e){E.push(e*1/100*w*1+e*1)}),e.findWhere({key:"damage"}).value=E.join(" > ")}}}},setDPS:function(){if(!this.get("selected"))return!1;if(this.get("name")=="Laser")return!1;var e=_(this.get("effects")),t=e.findWhere({key:"attack speed"}),n=e.findWhere({key:"avg damage"});n||(n=e.findWhere({key:"damage"}));var r=e.findWhere({key:"dps"});t&&n&&(dpsVal=leiminauts.utils.dps(n.value,t.value),r?r.value=dpsVal:e.push({key:"DPS",value:dpsVal}))},getActiveUpgrade:function(e){var t=_(this.getActiveUpgrades()).filter(function(t){return t.get("name").toLowerCase()==e.toLowerCase()});return t.length?t[0]:!1}}),leiminauts.Skills=Backbone.Collection.extend({model:leiminauts.Skill}),leiminauts.Upgrade=Backbone.Model.extend({defaults:{current_step:null,max_step:0,active:!1,locked:!1},initialize:function(e,t){var n=_(this.attributes).filter(function(e,t){return/^step[0-9]$/.test(t)&&e!==""}),r=new leiminauts.Steps([new leiminauts.Step({upgrade:this.toJSON()})]);_(n).each(function(e,t){r.add({level:t+1,description:e,upgrade:this.toJSON()})},this),this.set("steps",r),this.set("max_step",r.size()-1),this.set("description",_(this.get("description").replace(/\n/g,"<br>")).italics()),this.setStep(0)},setStep:function(e){e=parseInt(e,10);var t=this.get("steps").findWhere({level:e});this.set("current_step",t),this.set("active",t.get("level")>0)}}),leiminauts.Upgrades=Backbone.Collection.extend({model:leiminauts.Upgrade}),leiminauts.Step=Backbone.Model.extend({defaults:{level:0,description:""},initialize:function(){this.set("attrs",leiminauts.utils.treatEffects(this.get("description")))}}),leiminauts.Steps=Backbone.Collection.extend({model:leiminauts.Step}),leiminauts.CharactersView=Backbone.View.extend({className:"chars-list-container",events:{"click .char[data-id]":"selectCharacter"},initialize:function(){this.template=_.template($("#chars-tpl").html()),this.collection.on("add remove reset",this.render,this),this.options.character!==undefined&&(this.character=this.options.character.model.toJSON()),this.console=this.options.console!==undefined?this.options.console:!1,this.currentChar=null,this.mouseOverTimeout=null,this.$el.on("mouseover",".char",_.bind(_.debounce(this.showCharInfo,50),this))},render:function(){return this.$el.html(this.template({characters:this.collection.toJSON(),currentChar:this.currentChar,character:this.character,console:this.options.console})),this},selectCharacter:function(e){this.collection.trigger("selected",$(e.currentTarget).attr("data-id"))},showCharInfo:function(e){if(this.character)return!1;var t=$(e.currentTarget).attr("title");if(this.currentChar===null||this.currentChar.get("name")!==t)this.currentChar=this.collection.findWhere({name:t}),this.render()}}),leiminauts.CharacterView=Backbone.View.extend({tagName:"div",className:"char-builder",events:{"click .char-forum-switch button":"toggleForumViews"},initialize:function(e){_.defaults(e,{build:null,order:null,info:null,console:!1,forum:!1}),this.template=_.template($("#char-tpl").html()),this.console=e.console,this.forum=e.forum,this.characters=new leiminauts.CharactersView({character:this,collection:this.collection,console:this.console}),this.build=new leiminauts.BuildView({character:this,forum:this.forum}),this.info=new leiminauts.InfoView({character:this,forum:this.forum}),this.order=new leiminauts.OrderView({character:this,forum:this.forum}),this.order.on("changed",function(e){this.trigger("order:changed",e)},this),this.order.on("toggled",function(){this.trigger("order:toggled")},this),this.render(),this.toggleTimeout=null,this.model.on("change:maxed_out",this.toggleMaxedOutView,this)},render:function(){var e=this.model.toJSON();return e.console=this.console,e.forum=this.forum,this.$el.html(this.template(e)),this.assign(this.characters,".chars"),this.assign(this.build,".build"),this.assign(this.info,".char-info"),this.assign(this.order,".order"),this.forum&&this.toggleForumViews(null,"build"),this},toggleMaxedOutView:function(){if(!this.forum){var e=Modernizr.csstransitions?500:0;this.model.get("maxed_out")?this.toggleTimeout=setTimeout(_.bind(function(){this.$(".upgrade:not(.active)").addClass("hidden")},this),e):(clearTimeout(this.toggleTimeout),this.$(".upgrade:not(.active)").removeClass("hidden"))}setTimeout(_.bind(function(){this.$el.toggleClass("maxed-out",this.model.get("maxed_out")),this.$(".forum-snippet").attr("rows",this.model.get("maxed_out")?6:1)},this),0)},toggleForumViews:function(e,t){t=t||null,itemClass=t?t:$(e.currentTarget).attr("data-item"),this.$(".char-forum-switch button").removeClass("switch-active"),e&&$(e.currentTarget).addClass("switch-active"),t&&this.$('.char-forum-switch button[data-item="'+t+'"]').addClass("switch-active"),this.$(".build").toggleClass("forum-hidden",itemClass!="build"),this.$(".order").toggleClass("forum-hidden",itemClass!="order")}}),leiminauts.BuildView=Backbone.View.extend({tagName:"div",className:"build",events:{"click .build-cancel":"reset"},initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.forum=this.options.forum||!1,this.skills=[],this.model.get("skills").each(function(e){this.skills.push(new leiminauts.SkillView({model:e,forum:this.forum}))},this),this.template=_.template($("#build-tpl").html()),this.model.get("skills").on("change:active",this.toggleResetButtonClass,this),this.model.get("skills").each(_.bind(function(e){e.get("upgrades").on("change:active",this.toggleResetButtonClass,this)},this)),this.toggleResetButtonClass()},toggleResetButtonClass:function(){if(!this.$resetButton)return!1;var e=!1;this.model.get("skills").each(function(t){if(t.get("active")&&t.get("toggable")||t.getActiveUpgrades().length>0)return e=!0,!1}),this.$resetButton.toggleClass("active",e)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$resetButton=this.$(".build-cancel"),_(this.skills).each(function(e){e.delegateEvents(),this.$el.append(e.render().el)},this),this},reset:function(){this.model.get("skills").each(function(e){e.setActive(!1),e.get("toggable")||e.resetUpgradesState(!1)})}}),leiminauts.OrderView=Backbone.View.extend({tagName:"div",className:"order",initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.template=_.template($("#order-tpl").html()),this.active=!0,this.forum=this.options.forum,this.on("toggled",this.toggleView,this),this.collection=new Backbone.Collection(null,{comparator:this.comparator}),this.collection.on("reset",this.onBuildChange,this),this.model.get("skills").each(_.bind(function(e){e.get("upgrades").on("change:current_step",this.onBuildChange,this)},this)),this.model.get("skills").on("change:active",this.onBuildChange,this),this.on("sorted",this.render,this)},toggle:function(){this.active=!this.active,this.trigger("toggled")},toggleView:function(){if(!this.$el)return!1;this.$el.find("ul").toggleClass("hidden",!this.active),this.$el.find('input[name="active"]').prop("checked",this.active)},onBuildChange:function(e){this.updateCollection(e),this.render()},comparator:function(e){return e.get("order")||0},render:function(){var e=this.collection.toJSON(),t=0;return _(e).each(function(e){t+=e.upgrade?e.upgrade.cost*1:e.cost*1,e.order_total_cost=t,e.order_req_lvl=Math.floor((t-100)/100)<=1?1:Math.floor((t-100)/100)}),this.$el.html(this.template({items:e,active:this.active,forum:this.forum})),this.$(".order-item").on("mouseover mouseout click dragstart",this.handleTooltip),this.forum||(this.$('input[name="active"]').on("change",_.bind(this.toggle,this)),this.$list=this.$el.children("ul").first(),this.$list.sortable({items:".order-item"}),this.$list.on("sortupdate",_.bind(this.updateOrder,this))),this.toggleView(),this},updateCollection:function(e){if(e instanceof leiminauts.Skill)e.get("active")?this.collection.add(e,{sort:!1}):this.collection.remove(e);else if(e instanceof leiminauts.Upgrade){var t=e.get("current_step").get("level"),n=this.collection.filter(function(t){return t instanceof leiminauts.Step&&t.get("upgrade").name==e.get("name")});if(t!==0)if(t>1&&!n.length){var r=[];e.get("steps").each(function(e){e.get("level")<t&&r.push(e)}),this.collection.add(r,{sort:!1})}else this.collection.add(e.get("current_step"),{sort:!1});else this.collection.remove(n)}this.active&&this.trigger("changed",this.collection)},updateOrder:function(){return this.$list?(this.$list.children().each(_.bind(function(e,t){this.collection.get($(t).attr("data-cid")).set("order",e,{silent:!0})},this)),this.collection.sort(),this.active&&(this.trigger("changed",this.collection),this.trigger("sorted",this.collection)),!1):!1},handleTooltip:function(e){e.type=="mouseover"?MouseTooltip.show($(e.currentTarget).find(".order-popup").html()):MouseTooltip.hide()}}),leiminauts.InfoView=Backbone.View.extend({tagName:"div",className:"char-info",events:{"click .forum-snippet":"focusForumSnippet"},initialize:function(){this.options.character&&(this.character=this.options.character,this.model=this.character.model),this.template=_.template($("#info-tpl").html()),this.forum=this.options.forum||!1,this.model.on("change:total_cost",this.render,this)},render:function(){var e=this.model.toJSON();return e.forum=this.forum,this.$el.html(this.template(e)),this},focusForumSnippet:function(){this.$(".forum-snippet").select()}}),leiminauts.SkillView=Backbone.View.extend({tagName:"div",className:"skill-wrapper",events:{"mouseover .skill-icon":"handleTooltip","mouseout .skill-icon":"handleTooltip","click .skill-icon":"toggleState","click .skill-cancel":"reset"},initialize:function(){this.forum=this.options.forum||!1,this.upgrades=[],this.model.get("upgrades").each(function(e){this.upgrades.push(new leiminauts.UpgradeView({model:e,forum:this.forum}))},this),this.template=_.template($("#build-skill-tpl").html()),this.model.get("upgrades").on("change",this.renderUpgradesInfo,this),this.model.on("change",this.render,this)},toggleState:function(){if(this.forum)return!1;this.model.setActive(!this.model.get("active"))},reset:function(){this.model.setActive(!1),this.model.get("toggable")||this.model.resetUpgradesState(!1)},render:function(){var e=this.model.toJSON();return e.forum=this.forum,this.$el.html()?(this.$(".skill").toggleClass("active",e.active),this.$(".skill").toggleClass("skill-maxed-out",e.maxed_out),this.$(".skill-effects").toggleClass("hidden",!e.effects.length),this.$(".skill-cancel").toggleClass("active",e.toggable&&e.active||e.upgrades.where({active:!0}).length>0),_(this.upgrades).invoke("delegateEvents")):(this.$el.html(this.template(e)),_(this.upgrades).each(function(e){e.delegateEvents(),this.$(".skill-upgrades").append(e.render().el)},this)),this.renderUpgradesInfo(),this},renderUpgradesInfo:function(){var e=this.model.toJSON();e.forum=this.forum,this.$(".skill-effects").html(_.template($("#build-skill-effects-tpl").html(),e))},handleTooltip:function(e){e.type!="mouseout"?MouseTooltip.show(this.$(".skill-popup").html()):MouseTooltip.hide()}}),leiminauts.UpgradeView=Backbone.View.extend({tagName:"div",className:"upgrade",events:{mouseover:"handleTooltip",mouseout:"handleTooltip",click:"onClick"},initialize:function(){this.template=_.template($("#build-upgrade-tpl").html()),this.forum=this.options.forum||!1,this.model.on("change",this.render,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),_(["active","locked"]).each(function(e){this.$el.toggleClass(e,this.model.get(e))},this),this},onClick:function(e){if(this.forum)return!1;this.updateStep(),this.handleTooltip(e)},handleTooltip:function(e){e.type=="mouseover"?MouseTooltip.show(this.$(".upgrade-popup").html()):e.type=="click"?MouseTooltip.html(this.$(".upgrade-popup").html()):MouseTooltip.hide()},updateStep:function(){if(this.model.get("locked")){var e=this.model.get("skill");if(e&&e.get("active"))return!1;e&&e.setActive(!0)}var t=this.model.get("current_step")?this.model.get("current_step").get("level"):0;t>=this.model.get("max_step")?this.model.setStep(0):this.model.setStep(t+1)}}),leiminauts.App=Backbone.Router.extend({routes:{"(console)":"list",":naut(/:build)(/:order)(/console)(/forum)(/)":"buildMaker"},initialize:function(e){e.spreadsheet!==undefined&&(this.data=new leiminauts.CharactersData(null,{spreadsheet:e.spreadsheet,console:e.console}),this.data.on("selected",function(e){this.navigate(e,{trigger:!0})},this)),this.$el=$(e.el),this.console=e.console,$("html").toggleClass("console",this.console),this._beforeRoute(),this.grid=[],this.forum=e.forum},_beforeRoute:function(){var e=this.getCurrentUrl(),t=this.console!==undefined?this.console:undefined,n=this.forum!==undefined?this.forum:undefined;this.console=e.indexOf("console")!==-1,this.forum=e.indexOf("/forum")!==-1,t!==this.console&&window.location.reload(),n!==this.forum&&$("html").toggleClass("forum",this.forum)},updateSpecificLinks:function(){var e=this.getCurrentUrl();$(".console-button a").attr("href","/#"+(e.indexOf("console")!==-1?e.replace("console",""):e+"/console"));var t="[build]"+window.location.hash.substr(1)+"[/build]";$(".forum-snippet").val(t),$(".website-url").attr("href",window.location.href.replace("/forum",""))},list:function(){this._beforeRoute(),$("html").removeClass("page-blue").addClass("page-red");var e=new leiminauts.CharactersView({collection:this.data,console:this.console});this.showView(e),this.updateSpecificLinks()},buildMaker:function(e,t,n){if(!_.isNaN(parseInt(e,10)))return!1;this._beforeRoute(),e=="Skolldir"&&(e="Skølldir"),e=_.ununderscored(e).toLowerCase();if(this.currentView&&this.currentView instanceof leiminauts.CharacterView&&this.currentView.model&&this.currentView.model.get("name").toLowerCase()==e)return this.updateBuildFromUrl(this.currentView),this.updateSpecificLinks(),!0;$("html").addClass("page-blue").removeClass("page-red");var r=this.data.filter(function(t){var n=t.get("name").toLowerCase()==e;return t.set("selected",n),n});if(!r.length)return!1;r=r[0],r.reset();var i=new leiminauts.CharacterView({collection:this.data,model:r,console:this.console,forum:this.forum});this.showView(i),this._initGrid(),this.updateBuildFromUrl(i);var s=_.debounce(_.bind(function(){this.updateBuildUrl(i)},this),500);r.get("skills").on("change",s,this),i.on("order:changed",s,this),i.on("order:toggled",s,this),this.updateSpecificLinks()},showView:function(e){return this.currentView&&this.currentView.remove(),this.$el.html(e.render().el),this.currentView=e,e},updateBuildFromUrl:function(e){var t=e.model,n=this.getCurrentUrl(),r=n.split("/"),i=r.length>1?r[1]:null,s=r.length>2?r[2]:null;if(i===null)return t.reset(),!1;var o=null;for(var u=0;u<28;u++)u%7===0?(o=t.get("skills").at(u/7),o.setActive(i.charAt(u)==="1")):o&&o.get("upgrades").at(u%7-1).setStep(i.charAt(u));if(s){var a=this._initGrid(),f=s.split("-"),l=_(f).countBy(function(e){return e}),c={},h=[];_(f).each(function(e,t){var n=a[e-1];n instanceof leiminauts.Skill&&h.push(n),n instanceof leiminauts.Upgrade&&(l[e]>1||c[e]?(c[e]=c[e]?c[e]+1:1,l[e]=l[e]-1,h.push(n.get("steps").at(c[e]))):c[e]||h.push(n.get("steps").at(1)))}),e.order.collection.reset(h,{sort:!1})}else e.order.toggle()},updateBuildUrl:function(e){if(this.currentView instanceof leiminauts.CharactersView)return!1;var t=e.model,n=e.order.active?e.order.collection:null,r="",i=[],s="",o=[];t.get("skills").each(function(e){r+=e.get("active")?"1":"0",o.push(e),e.get("upgrades").each(function(e){o.push(e),r+=e.get("current_step").get("level")})}),n&&n.length>0&&(n.each(function(e){if(e instanceof leiminauts.Skill)i.push(_(o).indexOf(e)+1);else if(e instanceof leiminauts.Step){var t=_(o).filter(function(t){return t instanceof leiminauts.Upgrade&&t.get("name")==e.get("upgrade").name});t=t?t[0]:!1,t&&i.push(_(o).indexOf(t)+1)}}),s="/"+i.join("-"));var u=this.getCurrentUrl(),a="";if(u.indexOf("/")===-1)a=u+"/"+r+s;else{a=u.substring(0,u.indexOf("/")+1)+r+s;var f=["/forum","/console"];_(f).each(function(e){u.indexOf(e)!==-1&&(a+=e)})}this.navigate(a),this.updateSpecificLinks()},getCurrentUrl:function(){return _(window.location.hash.substring(1)).trim("/").replace("ø","o")},_initGrid:function(){if(this.currentView instanceof leiminauts.CharacterView&&this.grid.length>0&&this.gridChar==this.currentView.model.get("name"))return this.grid;var e=[];this.currentView.model.get("skills").each(function(t){e.push(t),t.get("upgrades").each(function(t){e.push(t)})}),this.gridChar=this.currentView.model.get("name"),this.grid=e}}),$(function(){FastClick.attach(document.body)}),function(){var e=window.location.hash.indexOf("console")!==-1,t=window.location.hash.indexOf("forum")!==-1,n=window.location.hostname==="localhost",r=n?"0AuPP-DBESPOedGZHb1Ata1hKdFhSRHVzamN0WVUwMWc":"0AuPP-DBESPOedF9hckdzMWVhc2c3Rkk1R2RTa1pUdWc",i=n?"dev":"steam";!n&&e&&(r="0AuPP-DBESPOedHJTeGo4QUZsY0hiUThaRWg1eUJrZFE",i="conso"),MouseTooltip.init({"3d":!0}),$("html").toggleClass("page-red",!window.location.hash.length),leiminauts.init=function(n){n=n||{},_.defaults(n,{el:"#container",spreadsheet:!1,console:e,forum:t}),window.nautsbuilder=new leiminauts.App(n),Backbone.history.start({pushState:!1})},leiminauts.lastDataUpdate=leiminauts.lastDataUpdate||0,leiminauts.localDate=Modernizr.localstorage&&localStorage.getItem("nautsbuilder.date")?localStorage.getItem("nautsbuilder.date"):0;var s=function(e){return"./json/"+i+"-"+e+".json"};if(e||leiminauts.lastDataUpdate===0||leiminauts.lastDataUpdate>leiminauts.localDate)$.when($.get(s("characters")),$.get(s("upgrades")),$.get(s("skills"))).done(function(t,n,r){leiminauts.init({spreadsheet:{characters:t[0],skills:r[0],upgrades:n[0]},console:e})});else{var o=!0;if(Modernizr.localstorage){var u=localStorage.getItem("nautsbuilder.characters"),a=localStorage.getItem("nautsbuilder.skills"),f=localStorage.getItem("nautsbuilder.upgrades");_([u,a,f]).each(function(e){if(!e||e==="undefined")return o=!1,!1}),o&&leiminauts.init({})}(!Modernizr.localstorage||!o)&&$.when($.get(s("characters")),$.get(s("upgrades")),$.get(s("skills"))).done(function(e,t,n){leiminauts.init({spreadsheet:{characters:e[0],skills:n[0],upgrades:t[0]},console:!1})})}}();